# finalizer와 cleaner 사용을 피하라

> 자바는 `finalizer`와 `cleaner`라는 두가지 객체 소멸자를 제공한다.
> 

**Finalizer는 예측할 수 없고, 상황에 따라 위험하여 일반적으로 불필요하다.** 오동작, 낮은 성능, 이식성 문제의 원인이 되기도 하여, 기본적으로 지양해야 한다.

(→ 자바 9에서 사용 자제 API로 지정 후 cleaner를 그 대안으로 소개한다)

********cleaner는******** finalizer보단 낫지만, ******************************************************************************여전히 예측할 수 없고 느리고 불필요한 경우가 많다.******************************************************************************

> cf) C++의 파괴자와 차이
특정 객체와 관련된 자원을 회수하는 보편적인 방법
비메모리 자원을 회수하는 용도로 사용된다.
> 

## finalizer와 cleaner의 단점

### 언제 실행되는지 모른다

finalizer와 cleaner는 실행되기까지 얼마나 걸릴지 알 수 없어 실행 타이밍이 중요한 ******************************************************************************************************제때 실행되어야 하는 작업은 절대 할 수 없다.******************************************************************************************************

실제로 현업에서도 인스턴스 자원회수가 멋대로 지연될 수도 있다.

finalizer 스레드는 다른 애플리케이션 스레드보다 우선순위가 낮아서 실행될 기회를 제대로 얻지 못해 OutOfMemoryError를 낼 수 있다. 자바 언어 명세는 어떤 스레드가 finalizer를 수행할지 명시하지 않기 때문에 해결법은 없고, finalizer를 사용하지 않아야 한다.

cleaner는 자신을 수행할 스레드를 제어할 수 있어서 좀 낫지만, 여전히 백그라운드에서 수행되며 가비지 컬렉터이 통제하에 있어 즉각 수행될 것이라는 보장이 없다.

뿐만 아니라 수행 여부조차도 보장하지 않는다. 아예 종료 작업을 전혀 수행하지 못한 채로 프로그램이 중단될 수 있다. 

**⇒ 프로그램 생애주기와 상관없는, 상태를 영구적으로 수정하는 작업에서는 절대 finalier나 cleaer에 의존해서는 안된다.**

ex) 데이터베이스같은 공유 자원의 영구 락 해제

### 성능이 심각하게 떨어진다

Finalizer가 가비지 컬렉터이 효율을 떨어뜨린다. 

### 보안 문제가 발생할 수 있다.

finalizer를 사용한 클래스는 finalizer 공격에 노출되어 심각한 보안 문제를 일으킬 수도 있다.

어떤 클래스(A)를 공격하려는 클래스(B)가 해당 클래스(A)를 상속 받는다. 그리고 그 공격 당한 클래스(A)의 인스턴스를 생성하는 도중에 예외가 발생하거나, 직렬화 할 때 예외가 발생하면, 생성되다 만 객체에서(A)악의적인 하위클래스의(B) finalizer가 실행될 수 있다. 그럼 이 finalier는 정적 필드에 자신의 참조를 할당해서 가비지 컬렉터가 수집하지 못하게 막을 수 있고 이 객체의 메서드를 호출해 애초에 허용되지 않은 작업을 수행할 수도 있다.

⇒ final 이 아닌 클래스를 finalizer 공격으로부터 방어하려면 아무 일도 하지 않는 finalize메서드를 만들고 final로 선언하자 (final 클래스들은 하위 클래스를 만들 수 없기 때문에 이 공격에서 안전하다.)

## finalizer와 cleaner의 대안

그렇다면 finalizer 혹은 cleaner를 사용하지 않고, 객체를 종료하는 방법은 무엇일까?

바로 `AutoCloseable` 을 구현하고, 클라이언트에서 인스턴스를 종료할 때 `close` 메서드를 호출해주는 것이다. 이때 일반적으로 예외가 발생해도 제대로 종료되도록 `try-with-resources`를 사용해야 한다.

또한, 각 인스턴스는 자신이 닫혔는지 추적하는 것이 좋다. close 메서드에서 이 객체는 더 이상 유효하지 않음을 필드에 기록하고, 다른 메서드는 이 필들르 검사해서 객체가 닫힌 후에 불렸다면 `IllegalStateException`을 던지는 것이다.

> 
> 
> 
> `cleaner`(자바 8까지는 `finalizer`)는**안전망**역할이나 중요하지 않은 **네이티브 자원 회수용**으로만 사용하자. 
> 물론 이런 경우라도
> **불확실성**과 **성능 저하**에 주의해야 한다.
>
